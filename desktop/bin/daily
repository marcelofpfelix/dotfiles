#!/bin/bash

################################################################################
#                                 FILE INFO
# Daily maintenance script for anacron
# Runs once per day, calling all configured daily tasks
################################################################################

set -Eeuo pipefail

cd "$(dirname "$0")" || exit 1
LIBS_DIR=${LIBS_DIR:="$HOME/lib"}
. "$LIBS_DIR/lib_utils.sh"

# Configuration
MARKER_DIR="/tmp"
TODAY=$(date +%Y-%m-%d)
MARKER_FILE="${MARKER_DIR}/daily-run-${TODAY}"
FORCE_RUN=false

# Daily tasks to run (add your scripts here)
# Format: "script-name" - script must be in same directory as this script
SCRIPT_DIR="$HOME/bin"
DAILY_SCRIPTS=(
    gsync
    wiki
)

# Commit message for git operations
COMMIT_MSG="auto-update"

# Log message helper
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >&2
}

# Check if already run today
check_already_run() {
    if [ -f "$MARKER_FILE" ]; then
        if [ "$FORCE_RUN" = true ]; then
            log "Force run: Removing existing marker file"
            rm -f "$MARKER_FILE"
        else
            log "ERROR: Already executed today (${TODAY})"
            update_status 1 "Already executed today"
            exit 1
        fi
    fi
}

# Clean up old marker files (older than 7 days)
cleanup_old_markers() {
    find "$MARKER_DIR" -name "daily-run-*" -type f -mtime +7 -delete 2>/dev/null || true
}

# Run a single daily script
run_script() {
    local script="$1"
    local script_path="${SCRIPT_DIR}/${script}"

    # Validate script exists and is executable
    if [ ! -f "$script_path" ]; then
        log "WARNING: Script not found: $script_path"
        return 1
    fi
    if [ ! -x "$script_path" ]; then
        log "WARNING: Script not executable: $script_path"
        return 1
    fi

    # Execute script
    log "Running: $script"
    if "$script_path"; then
        log "SUCCESS: $script"
        return 0
    else
        log "FAILED: $script (exit code: $?)"
        return 1
    fi
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force)
                FORCE_RUN=true
                shift
                ;;
            -h|--help)
                echo "Usage: $0 [-f|--force] [-h|--help]"
                echo "  -f, --force    Force run even if already executed today"
                echo "  -h, --help     Show this help message"
                exit 0
                ;;
            *)
                echo "Unknown option: $1" >&2
                echo "Use -h or --help for usage information" >&2
                exit 1
                ;;
        esac
    done
}

# Main execution
main() {
    log "Starting daily maintenance"

    # Check if already run today
    check_already_run

    # Create marker file to prevent concurrent runs
    touch "$MARKER_FILE"
    log "Created marker: $MARKER_FILE"

    # Clean up old markers
    cleanup_old_markers

    # Handle empty script list
    if [ ${#DAILY_SCRIPTS[@]} -eq 0 ]; then
        log "WARNING: No daily scripts configured"
        update_status 0 "OK (no scripts configured)"
        exit 0
    fi

    # Run all configured scripts
    local failed_scripts=()
    for script in "${DAILY_SCRIPTS[@]}"; do
        # Skip empty entries and comments
        [ -z "$script" ] && continue
        [[ "$script" =~ ^#.* ]] && continue

        # Run script and track failures
        run_script "$script" || failed_scripts+=("$script")
    done

    # Report results
    if [ ${#failed_scripts[@]} -gt 0 ]; then
        log "ERROR: ${#failed_scripts[@]} script(s) failed: ${failed_scripts[*]}"
        update_status 1 "Failed: ${failed_scripts[*]}"
        exit 1
    else
        log "SUCCESS: All scripts completed"
        update_status 0 "OK"
        exit 0
    fi
}

# Parse command line arguments and run main
parse_args "$@"
main
