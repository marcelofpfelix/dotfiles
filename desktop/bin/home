#!/bin/bash

################################################################################
#                                 FILE INFO
# ansible-playbook to update the dotfiles into
################################################################################

  # change to local directory
cd "$(dirname $0)"
  # load lib
# shellcheck source=.../default/lib/lib_utils.sh
. ../lib/lib_utils.sh

CLI="""
use: home
long: |
  Deploy home dotfiles repo
  Using homelab ansible repo
flags:
  - use: target
    short: Target server
    alias: t
    type: string
  - use: yes
    short: yesman mode (no questions asked, using defaults)
    alias: y
    type: bool
  - use: work
    short: use work inventory
    alias: w
    type: bool
  - use: fast
    short: fast deploy
    alias: f
    type: bool
"""
. ../lib/lib_cli.sh


dotfiles=~/gwt/marcelofpfelix/dotfiles/main
homework=~/gwt/marcelofpfelix/homework/main


local_copy() {

    # copy the dotfiles to the local directory
    cp -rT ${dotfiles}/default  ~
    cp -rT ${dotfiles}/desktop  ~
    cp -rT ${homework}/work     ~
    cp -rT ${homework}/workdesk ~

    # ignore jinja2 templates
    rm ~/.ssh/config.d/work.j2
    echo "Copied dotfiles to home directory"
    exit 0
}


home() {
    cmd=${ARGS[0]}
    target=${ARGS[1]}
    yesman=${ARGS[2]}
    work=${ARGS[3]}
    fast=${ARGS[4]}

    println "Running cli" "home" "-t ${target}" "-y ${yesman}" "-w ${work}" "-f ${fast}" n:b:c:b:c

    cd ~/git/marcelofpfelix/homelab/

    # check if $work is true
    if [ "$work" = "true" ]; then
        inventory=~/work.ini
        home_src=$homework
    else
        inventory=inventory.ini
        home_src=$dotfiles
    fi

    if [ "$fast" = "true" ]; then
        flags=""
    else
        flags=" -e set_ssh=true -e set_shrc=true"
    fi

    # check if $target is empty
    if [ -z "$target" ]; then
        if [ "$yesman" = "true" ]; then
            local_copy
        else
            target=$(grep -v -e '\[' -e '\#' -e '^$' $inventory | gum filter)
        fi
    fi

    log note "ansible-playbook home.yml -i $inventory -e \"target=$target\" -e \"home_src=$home_src\" $flags" # service=$service
    ansible-playbook home.yml -i $inventory -e "target=$target -e home_src=$home_src $flags" # " service=$service

}

[[ -n "$CMD" ]] && "$CMD"
