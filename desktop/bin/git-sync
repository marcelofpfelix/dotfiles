#!/bin/bash

################################################################################
#                                 FILE INFO
# Sync git repositories (supports both worktree and normal repos)
#
# Configuration format:
#   "path"          - sync using auto-detected default branch
#   "path:branch"   - sync using specified branch
#   "path:default"  - explicitly use auto-detected default branch
################################################################################

set -Eeu -o pipefail

  # change to local directory
cd "$(dirname $0)"
  # load lib
# shellcheck source=.../default/lib/lib_utils.sh
. ../lib/lib_utils.sh
. ../lib/lib_status.sh
. ../lib/lib_git.sh

# Configuration
SCRIPT_NAME="git-sync"
COMMIT_MSG="auto-update"

# Repositories to sync
REPOS=(
    "$HOME/gwt/marcelofpfelix/dotfiles/main"
    "$HOME/gwt/marcelofpfelix/homework/main"
)

# Log message helper
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

# Sync a single repository
sync_repo() {
    local repo_path="$1"
    local configured_branch="$2"

    # Validate repository exists
    if [ ! -d "$repo_path" ]; then
        log "ERROR: Repository not found: $repo_path"
        return 1
    fi

    cd "$repo_path" || {
        log "ERROR: Cannot access: $repo_path"
        return 1
    }

    log "Syncing: $repo_path"

    # Determine target branch
    local target_branch
    if [ -z "$configured_branch" ] || [ "$configured_branch" = "default" ]; then
        target_branch=$(get_default_branch)
        log "  Branch: $target_branch (default)"
    else
        target_branch="$configured_branch"
        log "  Branch: $target_branch (configured)"
    fi

    # Verify we're on the target branch
    local current_branch=$(get_current_branch)
    if [ "$current_branch" != "$target_branch" ]; then
        log "  WARNING: On '$current_branch', expected '$target_branch' - skipping"
        return 0
    fi

    # Sync repository
    log "  Fetching updates..."
    git fetch origin "$target_branch" 2>&1 || {
        log "  ERROR: Fetch failed"
        return 1
    }

    log "  Pulling changes..."
    git pull origin "$target_branch" 2>&1 || {
        log "  ERROR: Pull failed"
        return 1
    }

    # Stage all changes
    git add .

    # Commit and push if there are changes
    if ! git diff-index --quiet HEAD -- 2>/dev/null; then
        log "  Committing changes..."
        git commit -m "$COMMIT_MSG" 2>&1 || {
            log "  ERROR: Commit failed"
            return 1
        }

        log "  Pushing changes..."
        git push origin "$target_branch" 2>&1 || {
            log "  ERROR: Push failed"
            return 1
        }
        log "  ✓ Synced with changes"
    else
        log "  ✓ Already up to date"
    fi

    return 0
}

# Main execution
main() {
    log "Starting git-sync"

    local failed_repos=()
    local total=0
    local success=0

    # Process each repository
    for repo_config in "${REPOS[@]}"; do
        total=$((total + 1))

        # Parse configuration: "path" or "path:branch"
        local repo_path="${repo_config%%:*}"
        local branch=""
        [[ "$repo_config" == *:* ]] && branch="${repo_config#*:}"

        # Expand variables in path
        repo_path=$(eval echo "$repo_path")

        # Sync repository
        if sync_repo "$repo_path" "$branch"; then
            success=$((success + 1))
        else
            failed_repos+=("$repo_path")
        fi

        echo
    done

    # Report results
    log "Completed: $success/$total repositories"

    if [ ${#failed_repos[@]} -gt 0 ]; then
        log "Failed: ${failed_repos[*]}"
        update_status 1 "Failed: ${failed_repos[*]}"
        exit 1
    else
        log "All repositories synced successfully"
        update_status 0 "OK"
        exit 0
    fi
}

main
