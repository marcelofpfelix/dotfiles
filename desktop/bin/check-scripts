#!/bin/bash

################################################################################
#                                 FILE INFO
# Example script to parse and monitor /tmp/script-status.ini
################################################################################

#set -Eeuo pipefail

cd "$(dirname "$0")" || exit 1
LIBS_DIR=${LIBS_DIR:="$HOME/lib"}
. "$LIBS_DIR/lib_utils.sh"

LEMONBAR=1
STATUS_FILE="$HOME/script-status.ini"

if [ ! -f "$STATUS_FILE" ]; then
    log ERRO "No status file found at $STATUS_FILE"
    exit 1
fi

has_errors=0

# Check if status file has today's date
today_date="# $(date +%Y%m%d)"
first_line=$(head -n 1 "$STATUS_FILE")

if [ "$first_line" != "$today_date" ]; then
    has_errors=1
else
    while IFS=': ' read -r script_name exit_code message; do
        # Skip comment lines
        [[ "$script_name" =~ ^# ]] && continue

        if [ "$exit_code" != "0" ]; then
            has_errors=1
        fi
    done < "$STATUS_FILE"
fi

if [ "$has_errors" -eq 1 ]; then
    println "$(icon erro)" r

else
    println
fi
